services:
  cncnet-server:
    image: ghcr.io/rowtag/cncnet-server:latest
    container_name: cncnet-server
    restart: unless-stopped

    # ── Option A: Config via .env file (see .env.example) ─────────────────────
    # All settings can be configured in the .env file next to this file.
    # docker-compose loads .env automatically.
    environment:
      - CNCNET_SERVER__NAME=${CNCNET_SERVER__NAME}
      - CNCNET_SERVER__MAXCLIENTS=${CNCNET_SERVER__MAXCLIENTS}
      - CNCNET_SERVER__CLIENTTIMEOUT=${CNCNET_SERVER__CLIENTTIMEOUT}
      - CNCNET_MAINTENANCE__PASSWORD=${CNCNET_MAINTENANCE__PASSWORD}
      - CNCNET_MASTERSERVER__ENABLED=${CNCNET_MASTERSERVER__ENABLED}
      - CNCNET_MASTERSERVER__PASSWORD=${CNCNET_MASTERSERVER__PASSWORD}
      - CNCNET_TUNNELV3__PORT=${CNCNET_TUNNELV3__PORT}
      - CNCNET_TUNNELV2__PORT=${CNCNET_TUNNELV2__PORT}
      - CNCNET_TUNNELV3__IPLIMIT=${CNCNET_TUNNELV3__IPLIMIT}
      - CNCNET_TUNNELV2__IPLIMIT=${CNCNET_TUNNELV2__IPLIMIT}
      - CNCNET_SECURITY__IPBLACKLISTDURATIONHOURS=${CNCNET_SECURITY__IPBLACKLISTDURATIONHOURS}
      - CNCNET_WEBMONITOR__PORT=${CNCNET_WEBMONITOR__PORT}
      - CNCNET_LOGGING__MINIMUMLEVEL=${CNCNET_LOGGING__MINIMUMLEVEL}

    volumes:
      # Persist log files on the host
      - ./logs:/app/logs

      # ── Option B: Config via JSON file ──────────────────────────────────────
      # Instead of (or in addition to) the .env file, you can provide a
      # appsettings.local.json file:
      #
      #   cp appsettings.local.example.json appsettings.local.json
      #   nano appsettings.local.json
      #
      # Then uncomment the line below:
      # - ./appsettings.local.json:/app/appsettings.local.json:ro

    ports:
      - "${CNCNET_TUNNELV3__PORT}:${CNCNET_TUNNELV3__PORT}/udp"
      - "${CNCNET_TUNNELV2__PORT}:${CNCNET_TUNNELV2__PORT}/udp"
      - "${CNCNET_TUNNELV2__PORT}:${CNCNET_TUNNELV2__PORT}/tcp"
      - "8054:8054/udp"
      - "3478:3478/udp"
      - "${CNCNET_WEBMONITOR__PORT}:${CNCNET_WEBMONITOR__PORT}/tcp"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${CNCNET_WEBMONITOR__PORT}/json"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
